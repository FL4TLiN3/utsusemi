#!/usr/bin/env node

var program = require('commander'),
    path = require('path'),
    fs = require('fs'),
    util = require('../lib/util');

program
.version(JSON.parse(fs.readFileSync(__dirname + '/../package.json', 'utf8')).version)
.option('-t, --target [directory]', 'Add the specified directory of stab [./stub/]', './stub/')
.option('-p, --port [number]', 'specify port number [3000]', 3000)
.option('-n, --hostname [hostname]', 'specify hostname [localhost]', 'localhost')
.option('-s, --silent', 'suppress messages');

program
.command('start')
.description('Start Utsusemi Server.')
.action(function() {
    var Utsusemi = require('../'),
        utsusemi = new Utsusemi({
        port: program.port,
        hostname: program.hostname,
        silent: program.silent || false
    });
    utsusemi.add(path.join(process.cwd(), program.target));
    utsusemi.run();
});

program
.command('init')
.description('Initialize Utsusemi Server.')
.action(function() {
    fs.mkdirSync(path.join(process.cwd(), 'stub/'));
});

program
.command('add')
.description('Add Stub.')
.action(function(url) {
    var _path = url.split('/'),
        endpoint = _path.pop(),
        dirname = path.join('stub'),
        filename = path.join('stub', url + '.json');
    if (!fs.existsSync(filename)) {
        _path.forEach(function(dir) {
            dirname = path.join(dirname, dir);
            if (!fs.existsSync(dirname)) {
                fs.mkdirSync(dirname);
            }
        });
        fs.writeFileSync(filename, '');
    } else {
        util.info('%s is already exists.', filename);
    }
});

program.parse(process.argv);

